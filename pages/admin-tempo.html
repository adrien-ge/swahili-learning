<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Normaliser les mots Swahili</title>
  <script type="module">
    import { db } from "../js/firebase-config.js";
    import {
    getFirestore,
    collection,        // âœ… AJOUTE ceci
    getDocs,
    updateDoc,
    deleteDoc,
    doc
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

async function supprimerUtilisateursSansNom() {
  const status = document.getElementById("status");
  status.innerText = "ğŸ”„ Suppression en cours...";
  let total = 0;
  let supprimÃ©s = 0;

  try {
    const usersRef = collection(db, "users");
    const snapshot = await getDocs(usersRef);

    for (const docSnap of snapshot.docs) {
      const data = docSnap.data();
      total++;
      if (!data.nom || data.nom.trim() === "") {
        await deleteDoc(doc(db, "users", docSnap.id));
        console.log("ğŸ—‘ SupprimÃ© :", docSnap.id);
        supprimÃ©s++;
      }
    }

    status.innerText = `âœ”ï¸ ${supprimÃ©s} utilisateurs supprimÃ©s sur ${total}`;
  } catch (error) {
    console.error("Erreur pendant la suppression :", error);
    status.innerText = "âŒ Erreur pendant la suppression";
  }
}

// âœ… Rendre disponible globalement pour un bouton HTML
window.supprimerUtilisateursSansNom = supprimerUtilisateursSansNom;

    function normaliserTexte(str) {
      return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
    }

    async function normaliserTousLesMotsExistants() {
      const status = document.getElementById("status");
      status.innerText = "ğŸ”„ Normalisation en cours...";
      let total = 0;
      let maj = 0;

      try {
        const motsRef = collection(db, "mots_swahili");
        const snapshot = await getDocs(motsRef);

        for (const docSnap of snapshot.docs) {
          const data = docSnap.data();
          if (!data.swahiliNormalise) {
            const normalise = normaliserTexte(data.swahili || "");
            await updateDoc(doc(db, "mots_swahili", docSnap.id), {
              swahiliNormalise: normalise
            });
            console.log(`âœ… ${data.swahili} â†’ ${normalise}`);
            maj++;
          }
          total++;
        }

        status.innerText = `âœ”ï¸ ${maj} mots normalisÃ©s sur ${total}`;
      } catch (err) {
        console.error("Erreur :", err);
        status.innerText = "âŒ Erreur pendant la normalisation";
      }
    }

    window.normaliserTousLesMotsExistants = normaliserTousLesMotsExistants;

    async function mettreMajusculeSwahiliEtFrancais() {
  const status = document.getElementById("status");
  status.innerText = "ğŸ”„ Mise en majuscule des champs swahili et franÃ§ais...";
  let total = 0;
  let maj = 0;

  try {
    const motsRef = collection(db, "mots_swahili");
    const snapshot = await getDocs(motsRef);

    for (const docSnap of snapshot.docs) {
      const data = docSnap.data();
      const ancienSw = data.swahili || "";
      const ancienFr = data.francais || "";

      const swMaj = ancienSw.charAt(0).toUpperCase() + ancienSw.slice(1).toLowerCase();
      const frMaj = ancienFr.charAt(0).toUpperCase() + ancienFr.slice(1).toLowerCase();

      // Appliquer uniquement si changement dÃ©tectÃ©
      if (ancienSw !== swMaj || ancienFr !== frMaj) {
        await updateDoc(doc(db, "mots_swahili", docSnap.id), {
          swahili: swMaj,
          francais: frMaj
        });
        console.log(`ğŸ”¤ ${ancienSw} â†’ ${swMaj} | ${ancienFr} â†’ ${frMaj}`);
        maj++;
      }

      total++;
    }


    status.innerText = `âœ”ï¸ ${maj} mots mis Ã  jour sur ${total}`;
  } catch (err) {
    console.error("Erreur :", err);
    status.innerText = "âŒ Erreur pendant la mise Ã  jour";
  }
}


window.mettreMajusculeSwahiliEtFrancais = mettreMajusculeSwahiliEtFrancais;

  </script>
  <style>
    body { font-family: sans-serif; padding: 2rem; text-align: center; }
    button { font-size: 1.2rem; padding: 1rem 2rem; margin-top: 2rem; }
    #status { margin-top: 2rem; font-weight: bold; }
  </style>
</head>
<body>
  <h1>âš™ï¸ Normalisation des mots Swahili</h1>
  <p>Cette opÃ©ration ajoutera le champ <code>swahiliNormalise</code> Ã  tous les mots qui n'en ont pas dÃ©jÃ .</p>
  <button onclick="normaliserTousLesMotsExistants()">Lancer la normalisation</button>
  

  <h1>âš™ï¸ Normalisation des mots Swahili</h1>
  <p>Cette opÃ©ration ajoutera le champ <code>swahiliNormalise</code> Ã  tous les mots qui n'en ont pas dÃ©jÃ .</p>
  <button onclick="mettreMajusculeSwahiliEtFrancais()">ğŸ”  Mettre une majuscule Ã  Swahili + FranÃ§ais</button>
  

  <h2>ğŸ§¹ Nettoyage des utilisateurs anonymes</h2>
  <button onclick="supprimerUtilisateursSansNom()">ğŸ—‘ Supprimer les utilisateurs sans prÃ©nom</button>
  
  
  <div id="status"></div>

</body>
</html>
